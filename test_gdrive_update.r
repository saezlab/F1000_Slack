
# test google drive api

library(googledrive)
library(readr)

# get command line secret inputs
args <- commandArgs(trailingOnly = TRUE)

print(args)

# get the first input, which is the credential string
#credentials = "ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiZjEwMDBib3QiLAogICJwcml2YXRlX2tleV9pZCI6ICI5MThiMWRlYzBjODkxNzFiZDgwNTNkNTYzMGZmYmU4NGZkMTQ1NWYxIiwKICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUlFdkFJQkFEQU5CZ2txaGtpRzl3MEJBUUVGQUFTQ0JLWXdnZ1NpQWdFQUFvSUJBUUNsSDhnZVh2UytxMDdOXG5aRS9ZakxFbGxCdGNSYjVXYmpoQlhPYXdXQld4OGVicHo4VjlyVGZRUlV4UTEwaUZLSHNXV0dLREtMQXoxZzNCXG40NitXMEFGVk9HK3JtNVFNL0hFQVJDUlE3emRrLzZkVmtIbWFsMlhrT25RRWdPSCtpMis2dkhzdm0yRWJ0VlBjXG5FRzEyemxlOUpaY0N6N25zblMvTTBMOUxhcHh1YWl0M0ZML2NhaWpuUHpLS0w1UG5wVTdPQm1WT1E4N3JsVllxXG5NTmt5UWVZeTZiblJOMEJyaWJ3V0FIOE9Gcmp2QXE4YjRhQk40TnNZZ1lJaXhUYlhzODM0Vy9qRCtDUUR1SDRpXG5OZHVsK2RzekVtd0pVL2tPVnhISGkxR1ZrQm1KUHFYb2JaamNrNGo0Q2ZSNFo1UVpUVkgyNW5sWEJ0N3NPR0lMXG5NZURzUndXSkFnTUJBQUVDZ2dFQUFrRHAxRW56RHZaa2V6bGhoRE9Kc1FCQmdib1B4LzZyQStpVGpRZ0xaRStXXG5vSU1WOUxhZ3dHdEVKTnQ0Yk90ZUFGbXg3VVdoZ3poRFIvRkx4VUpHRVVXcTgwV0hDT3hJQk02czA3Vnloc1pBXG5uTm1TOS9YcTNZbGFvcjhMRGFtY3BpaXZrRzZka1dkekZzOFQrZEhUUVBrUEVkRlNsdlA3MlJDbk53blpoQjRSXG41TlZWWmlwRXlORSs1WHlnUkdIVzNldTRBNEFPWVVjWUZML1REWlhLRHpXeTFlNDlFRURLb21ZeVMwSmRXQ281XG5ZY0swMzdXdnFPbUJMTWp5WkZvdWIxM1BnZDZGNVRkZFlQcW1LMkpKMGZ6OVNTWVAvOVJ1QVhPd0dYdGdqNkJRXG5XTERlQTk1OXl3czFucGtkbFdLeklFOGlSZ1hia0FsVkdjcTlIOTFNd1FLQmdRRGMzeWRwemlkQ0VpTGxoZEcxXG54SGFLZnkvRkg0b2FhZXAzUEpMckRqd3c0dm9hYmw4d3ZRWUg4Q25PUVhqL0N1RVdiSE4zVFJ1aTl5eHhBaFZQXG52ejYzNDcrak0xRWZaNUJ4VU5qWXBPVlBrMlVHa291T2l4aEtZM0hPN3Zlczh1UXNWNkd4ZjJaeUhpNnBrdG5DXG51cFN0TUE2RFdNUnFXMWVwRlBwWVUyeG5RUUtCZ1FDL1l0bzdlVXN5VGg2VXdEbWF5MzZsSmJiT2xRa1RwelorXG5OMXMrTHduODZnUmlVMWprUzJzRGwvUzJPZWk0Z3QrenBrb3ltV3ZodlpBZEhBNlJ6eUVmZXVvRnN2MVc4cDlaXG4xYXNmT2d5YXBvQm83MEZwUGx6MFFlU21LeDJ0VXArcTJGTTBkWkgzTThKbWxXRE1WMDVRcnJZTmNSNGtIemQyXG5WRklLVjZ5VVNRS0JnRXBybmxvV0xrQWk0RU01M2JsREl6WHpPT05RaHpYekxoOVM5NlhmdkFRMDFsU0ZqK2xhXG5KMmdSVWVTL1JzZVlvTkx2WTlCMDJMVUdWNkVVTko0VU1FdkJuMWFiK2Q5OUE3eEtvMllMMllBQWgrKzQvUERnXG5pU1MzY1NkcWVXVjZ5Y3J2RS9vOGxRWXFpVXAxd28zTVZFQXVpeFZTbVl2RWp6clhhS3JPSVI2QkFvR0FFbFZmXG4zbTZpRzNHTVVHZVJuUmg5UzBpdm1GNkNmaFY0ak9LMHBPSlFySittUjkwQUdPNTRrK0dNbWFBMmdPWllrNWNNXG5hSWgxNHl3TGtCNU43djNPaUh0M3k0LzM0TXBoSlhQb2JwZGErYjJWYzNmbjVqTUpLSVRmYUdPYzlpdUNEQldvXG44cytJYWd2VlJZcHR1V1ZycFNMM1laWkNjdWRpb3IwMUZyU0xYYkVDZ1lBYURPdzFHRUFjdGIrLytFaHBSRTJnXG53dDlmdHpsWHY3ZDZGb1BYb0RxZkliTFA0UFBMNWswYzJDaU1KRmUwZUVjczl2V1pqU2pLbmpRVlhtVmNJVFc4XG5SRHhRTWhFM3UyUEVMWnREME5EOTdjOXk2a1IxTFJRWld0WFZvVUU4ellUTnpmNW1hTFNBb2tCRWN3c041bWtrXG4reWlvOHhYOWMxT3o3amxNVFZvVGZnPT1cbi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS1cbiIsCiAgImNsaWVudF9lbWFpbCI6ICJmMTAwMGJvdC1zZXJ2aWNlLWFjY291bnRAZjEwMDBib3QuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTE1ODkyNDY5MTIyNzMwMTY2MTA0IiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9mMTAwMGJvdC1zZXJ2aWNlLWFjY291bnQlNDBmMTAwMGJvdC5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIsCiAgInVuaXZlcnNlX2RvbWFpbiI6ICJnb29nbGVhcGlzLmNvbSIKfQo="
credentials <- args[[1]]

# second input: file path
#file_path <- "https://drive.google.com/file/d/1XVQnOnNg4SJxwaSq9PnUvKGzsl5wmp1o/view?usp=drive_link"
file_path <- args[[2]]

# authenticate
drive_auth(path = rawToChar(base64enc::base64decode(credentials)), email = "f1000bot-service-account@f1000bot.iam.gserviceaccount.com" )

# read the file from google drive
state <- drive_read_string(file = file_path) %>% read_csv()


# update the last date by current date
state$lastDate <- Sys.time() %>% as.numeric()


# write the file back to google drive

state %>% write_csv("./temp.csv")
drive_update(file = file_path, media = "./temp.csv")
